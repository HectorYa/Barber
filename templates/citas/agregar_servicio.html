{% extends "layout.html" %}
{% block content %}

<div class="container py-4">
  <h4 class="mb-4">Agregar servicios a la cita de <strong>{{ reserva.cliente.nombre }}</strong></h4>

  <form method="POST">
    <div class="form-row">
      <div class="form-group col-md-4">
        <label for="servicio">Servicio</label>
        <input class="form-control" list="servicios" id="servicio" placeholder="Buscar servicio..." required>
        <datalist id="servicios">
          {% for s in servicios %}
          <option data-id="{{ s.id }}" data-precio="{{ s.precio_base }}" value="{{ s.nombre }}">
          {{ s.nombre }}
          </option>

          {% endfor %}
        </datalist>
      </div>
        <input type="hidden" name="servicio_id" id="servicio_id_real">

      <div class="form-group col-md-3">
        <label for="barbero">Barbero</label>
        <select class="form-control" id="barbero" name="barbero_id" required>
          {% for b in barberos %}
          <option value="{{ b.id }}">{{ b.nickname }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group col-md-2">
        <label for="precio">Monto (S/.)</label>
        <input type="number" step="0.10" class="form-control" name="precio_final" id="precio" placeholder="0.00" required>
      </div>

      <div class="form-group col-md-3">
        <label for="persona">¿Quién se hará el corte?</label>
        <input type="text" class="form-control" name="persona_atendida" id="persona" placeholder="Ej. Pepito Jr.">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group col-md-3">
        <label for="fecha">Fecha de la cita</label>
        <input type="date" class="form-control" name="fecha" id="fecha" value="{{ reserva.fecha_reserva }}">
      </div>
      <div class="form-group col-md-2">
        <label for="hora">Hora de la cita</label>
        <input type="time" class="form-control" name="hora" id="hora">
      </div>
      <div class="form-group col-md-2">
        <label for="porcentaje_barbero">% para el barbero</label>
        <input type="number" class="form-control" id="porcentaje_barbero" name="porcentaje_barbero" min="0" max="100" step="1" value="50" required>
      </div>

    </div>


    <div class="form-group">
      <label for="comentario">Comentario (opcional)</label>
      <textarea class="form-control" name="comentario" id="comentario" rows="2"></textarea>
    </div>

    <button type="submit" class="btn btn-primary">
      <i class="fas fa-plus"></i> Agregar servicio
    </button>
  </form>

  <hr>

  <h5 class="mt-4">Servicios agregados</h5>
  {% if reserva_servicios %}
  <table class="table table-bordered">
    <thead class="thead-light">
      <tr>
        <th>Servicio</th>
        <th>Barbero</th>
        <th>Persona</th>
        <th>Precio</th>
        <th>Comentario</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% set total = namespace(value=0) %}

      {% for rs in reserva_servicios %}
        {% set total.value = total.value + (rs.precio_final or 0) %}
        <tr>
          <td>
          {% if rs.servicio %}
            {{ rs.servicio.nombre }}
          {% else %}
            <span class="text-danger">❌ Servicio no enlazado</span>
          {% endif %}
          </td>
          <td>{{ rs.barbero.nickname }}</td>
          <td>{{ rs.persona_atendida }}</td>
          <td>S/. {{ '%.2f' % rs.precio_final }}</td>
          <td>{{ rs.comentario or '-' }}</td>
          <td>
            <form method="POST" action="{{ url_for('main.eliminar_reserva_servicio', id=rs.id) }}" onsubmit="return confirm('¿Eliminar este servicio?');">
              <button class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
            </form>
          </td>
        </tr>
      {% endfor %}

      <tfoot>
        <tr>
          <th colspan="3" class="text-right">Total</th>
          <th colspan="3">S/. {{ '%.2f' % total.value }}</th>
        </tr>
      </tfoot>
  </table>

  <div class="mt-3">
    <form method="POST" action="{{ url_for('main.finalizar_reserva', reserva_id=reserva.id) }}">
      <div class="form-group">
        <label for="metodo_pago">Método de pago</label>
        <select class="form-control" id="metodo_pago" name="metodo_pago">
          <option value="">Omitir (en espera)</option>
          <option value="efectivo">Efectivo</option>
          <option value="yape">Yape</option>
          <option value="plin">Plin</option>
          <option value="otro">Otro</option>
        </select>
      </div>
      <button type="submit" class="btn btn-success">
        <i class="fas fa-check"></i> Finalizar y guardar cita
      </button>
    </form>
  </div>

  {% else %}
    <div class="alert alert-warning">Aún no se han agregado servicios.</div>
  {% endif %}
</div>

{% endblock %}


